<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图片像素化转换器</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        
        .upload-section {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            background: #fafafa;
        }
        
        .upload-section.dragover {
            border-color: #144eb9;
            background: #f0f4ff;
        }
        
        .file-input {
            display: none;
        }
        
        .upload-btn {
            background-color: #144eb9;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .upload-btn:hover {
            background-color: #0f3d9e;
        }
        
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .control-group {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 6px;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }
        
        .control-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .slider-container {
            margin: 10px 0;
        }

        .slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #ddd;
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #144eb9;
            cursor: pointer;
        }

        .slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #144eb9;
            cursor: pointer;
            border: none;
        }

        .slider-value {
            display: inline-block;
            background: #144eb9;
            color: white;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 12px;
            margin-left: 10px;
        }

        .stats {
            background: #e8f4fd;
            border: 1px solid #b8daff;
            border-radius: 6px;
            padding: 15px;
            margin: 20px 0;
            font-family: monospace;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 18px;
            font-weight: bold;
            color: #144eb9;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }

        .effect-demo {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
        }

        .pixel-grid {
            display: inline-block;
            margin: 0 10px;
        }

        .pixel-block {
            width: 8px;
            height: 8px;
            display: inline-block;
            border: 1px solid #ccc;
            margin: 1px;
        }

        .demo-arrow {
            font-size: 20px;
            color: #144eb9;
            margin: 0 15px;
        }
        
        .preview-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 30px;
        }
        
        .preview-box {
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            background: white;
        }
        
        .preview-header {
            background: #f8f9fa;
            padding: 15px;
            font-weight: bold;
            color: #555;
            border-bottom: 1px solid #ddd;
        }
        
        .preview-content {
            padding: 20px;
            text-align: center;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .preview-image {
            max-width: 100%;
            max-height: 400px;
            border: 1px solid #eee;
            image-rendering: pixelated;
        }
        
        .process-btn {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin-bottom: 20px;
        }
        
        .process-btn:hover {
            background-color: #218838;
        }
        
        .process-btn:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        .info {
            background: #e7f3ff;
            border: 1px solid #b3d7ff;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
            color: #0066cc;
        }
        
        .error {
            background: #ffe7e7;
            border: 1px solid #ffb3b3;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
            color: #cc0000;
        }
        
        .status {
            text-align: center;
            margin: 20px 0;
            font-style: italic;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>图片像素化转换器</h1>
        
        <div class="upload-section" id="uploadSection">
            <input type="file" id="fileInput" class="file-input" accept="image/png,image/jpeg,image/webp,image/bmp,image/gif">
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">选择图片文件</button>
            <p>或拖拽图片文件到此处</p>
            <p><small>支持 PNG, JPEG, WebP, BMP, GIF 格式</small></p>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <label>像素化强度 (快速调节):</label>
                <div class="slider-container">
                    <input type="range" id="pixelationSlider" class="slider" min="1" max="50" value="10" oninput="updatePixelationPreview()">
                    <span class="slider-value" id="sliderValue">10x</span>
                </div>
                <small style="color: #666;">
                    拖动滑块实时预览效果<br>
                    • 1x = 原图不变 • 10x = 适中效果 • 50x = 极度像素化
                </small>
            </div>
            <div class="control-group">
                <label>高级设置 (独立控制XY轴):</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div>
                        <label style="font-size: 12px;">X轴倍数 (宽度压缩):</label>
                        <input type="number" id="pixelationX" value="10" min="1" max="100" onchange="updatePixelationPreview()">
                    </div>
                    <div>
                        <label style="font-size: 12px;">Y轴倍数 (高度压缩):</label>
                        <input type="number" id="pixelationY" value="10" min="1" max="100" onchange="updatePixelationPreview()">
                    </div>
                </div>
                <small style="color: #666;">
                    • X轴=5, Y轴=10 → 横向5像素、纵向10像素合并为1像素<br>
                    • 不同XY值可创造拉伸效果
                </small>
                
                <div class="effect-demo" id="effectDemo">
                    <div style="margin-bottom: 10px; font-weight: bold; color: #333;">像素化原理演示</div>
                    <div id="pixelDemoContent">选择图片后查看实时演示</div>
                </div>
            </div>
        </div>

        <div class="stats" id="imageStats" style="display: none;">
            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-number" id="originalPixels">0</div>
                    <div class="stat-label">原始像素</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="pixelatedPixels">0</div>
                    <div class="stat-label">像素化后</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="compressionRatio">0x</div>
                    <div class="stat-label">压缩比</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="reductionPercent">0%</div>
                    <div class="stat-label">减少比例</div>
                </div>
            </div>
        </div>
        
        <button class="process-btn" id="processBtn" disabled onclick="processImage()">开始像素化转换</button>
        
        <div class="status" id="status"></div>
        
        <div class="preview-section">
            <div class="preview-box">
                <div class="preview-header">原图预览</div>
                <div class="preview-content" id="originalPreview">
                    <span style="color: #999;">请先选择图片文件</span>
                </div>
            </div>
            
            <div class="preview-box">
                <div class="preview-header">像素化效果预览</div>
                <div class="preview-content" id="pixelatedPreview">
                    <span style="color: #999;">等待处理...</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentFile = null;
        let originalBitmap = null;

        // 拖拽功能
        const uploadSection = document.getElementById('uploadSection');
        const fileInput = document.getElementById('fileInput');
        const processBtn = document.getElementById('processBtn');
        const status = document.getElementById('status');

        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });

        uploadSection.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
        });

        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        async function handleFile(file) {
            const validTypes = ['image/png', 'image/jpeg', 'image/webp', 'image/bmp', 'image/gif'];
            if (!validTypes.includes(file.type)) {
                alert('请选择有效的图片文件格式！');
                return;
            }

            currentFile = file;
            processBtn.disabled = false;
            
            // 创建ImageBitmap用于实时预览
            originalBitmap = await createImageBitmap(file);
            
            // 显示原图预览
            const reader = new FileReader();
            reader.onload = (e) => {
                const originalPreview = document.getElementById('originalPreview');
                originalPreview.innerHTML = `
                    <img src="${e.target.result}" class="preview-image" alt="原图预览">
                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                        文件名: ${file.name}<br>
                        大小: ${(file.size / 1024).toFixed(2)} KB<br>
                        尺寸: ${originalBitmap.width} × ${originalBitmap.height}
                    </div>
                `;
                
                // 显示统计信息
                document.getElementById('imageStats').style.display = 'block';
                updateImageStats();
                
                // 立即显示像素化预览
                updatePixelationPreview();
            };
            reader.readAsDataURL(file);
            
            status.textContent = `已选择文件: ${file.name}`;
        }

        function updateSliderValue() {
            const slider = document.getElementById('pixelationSlider');
            const pixelationX = document.getElementById('pixelationX');
            const pixelationY = document.getElementById('pixelationY');
            const sliderValue = document.getElementById('sliderValue');
            
            const value = slider.value;
            sliderValue.textContent = value + 'x';
            pixelationX.value = value;
            pixelationY.value = value;
        }

        async function updatePixelationPreview() {
            if (!originalBitmap) return;
            
            const slider = document.getElementById('pixelationSlider');
            const pixelationX = document.getElementById('pixelationX');
            const pixelationY = document.getElementById('pixelationY');
            
            // 同步滑块和输入框
            if (document.activeElement === slider) {
                updateSliderValue();
            }
            
            const xValue = parseInt(pixelationX.value);
            const yValue = parseInt(pixelationY.value);
            
            try {
                // 应用像素化
                const pixelatedBitmap = await applyPixelation(originalBitmap, xValue, yValue);
                
                // 更新预览
                displayPixelatedPreview(pixelatedBitmap, xValue, yValue);
                
                // 更新统计
                updateImageStats(pixelatedBitmap.width * pixelatedBitmap.height);
                
            } catch (error) {
                console.error('实时预览出错:', error);
            }
        }

        function displayPixelatedPreview(pixelatedBitmap, pixelationX, pixelationY) {
            const pixelatedPreview = document.getElementById('pixelatedPreview');
            
            // 计算显示尺寸
            const maxDisplaySize = 400;
            const scale = Math.min(maxDisplaySize / pixelatedBitmap.width, maxDisplaySize / pixelatedBitmap.height);
            const displayWidth = Math.floor(pixelatedBitmap.width * scale);
            const displayHeight = Math.floor(pixelatedBitmap.height * scale);
            
            pixelatedPreview.innerHTML = `
                <canvas width="${displayWidth}" height="${displayHeight}" 
                        class="preview-image" style="border: 1px solid #eee; image-rendering: pixelated; image-rendering: -moz-crisp-edges; image-rendering: crisp-edges;"></canvas>
                <div style="margin-top: 10px; font-size: 12px; color: #666;">
                    像素化尺寸: ${pixelatedBitmap.width} × ${pixelatedBitmap.height}<br>
                    像素化倍数: ${pixelationX} × ${pixelationY}
                </div>
            `;
            
            const previewCanvas = pixelatedPreview.querySelector('canvas');
            const previewCtx = previewCanvas.getContext('2d');
            previewCtx.imageSmoothingEnabled = false;
            previewCtx.drawImage(pixelatedBitmap, 0, 0, displayWidth, displayHeight);
        }

        function updateImageStats(pixelatedPixelCount = null) {
            if (!originalBitmap) return;
            
            const originalPixelCount = originalBitmap.width * originalBitmap.height;
            
            // 计算当前设置下的像素化结果
            if (pixelatedPixelCount === null) {
                const pixelationX = parseInt(document.getElementById('pixelationX').value);
                const pixelationY = parseInt(document.getElementById('pixelationY').value);
                const newWidth = Math.ceil(originalBitmap.width / pixelationX);
                const newHeight = Math.ceil(originalBitmap.height / pixelationY);
                pixelatedPixelCount = newWidth * newHeight;
            }
            
            const compressionRatio = originalPixelCount / pixelatedPixelCount;
            const reductionPercent = ((originalPixelCount - pixelatedPixelCount) / originalPixelCount * 100);
            
            // 格式化数字显示
            document.getElementById('originalPixels').textContent = originalPixelCount.toLocaleString();
            document.getElementById('pixelatedPixels').textContent = pixelatedPixelCount.toLocaleString();
            document.getElementById('compressionRatio').textContent = compressionRatio.toFixed(1) + 'x';
            document.getElementById('reductionPercent').textContent = reductionPercent.toFixed(1) + '%';
            
            // 更新原理演示
            updatePixelDemo();
        }

        function updatePixelDemo() {
            const pixelationX = parseInt(document.getElementById('pixelationX').value);
            const pixelationY = parseInt(document.getElementById('pixelationY').value);
            const demoContent = document.getElementById('pixelDemoContent');
            
            if (!originalBitmap) {
                demoContent.innerHTML = '选择图片后查看实时演示';
                return;
            }
            
            // 计算实际尺寸变化
            const originalWidth = originalBitmap.width;
            const originalHeight = originalBitmap.height;
            const newWidth = Math.ceil(originalWidth / pixelationX);
            const newHeight = Math.ceil(originalHeight / pixelationY);
            
            demoContent.innerHTML = `
                <div style="display: flex; align-items: center; justify-content: center; flex-wrap: wrap;">
                    <div style="text-align: center; margin: 10px;">
                        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">原始像素块</div>
                        <div style="border: 2px solid #28a745; padding: 5px; display: inline-block;">
                            ${createPixelGrid(pixelationX, pixelationY, '#e3f2fd')}
                        </div>
                        <div style="font-size: 11px; margin-top: 3px;">${pixelationX}×${pixelationY} = ${pixelationX * pixelationY}像素</div>
                    </div>
                    
                    <div class="demo-arrow">→</div>
                    
                    <div style="text-align: center; margin: 10px;">
                        <div style="font-size: 12px; color: #666; margin-bottom: 5px;">合并后</div>
                        <div style="border: 2px solid #144eb9; padding: 5px; display: inline-block;">
                            ${createPixelGrid(1, 1, '#144eb9')}
                        </div>
                        <div style="font-size: 11px; margin-top: 3px;">1像素(平均色)</div>
                    </div>
                </div>
                
                <div style="margin-top: 15px; padding-top: 10px; border-top: 1px solid #ddd; font-size: 12px;">
                    <strong>尺寸变化:</strong> ${originalWidth}×${originalHeight} → ${newWidth}×${newHeight}<br>
                    <strong>处理方式:</strong> 每${pixelationX}×${pixelationY}个像素合并成1个像素
                </div>
            `;
        }

        function createPixelGrid(width, height, color) {
            let grid = '';
            for (let y = 0; y < height; y++) {
                for (let x = 0; x < width; x++) {
                    grid += `<div class="pixel-block" style="background-color: ${color};"></div>`;
                }
                if (y < height - 1) grid += '<br>';
            }
            return grid;
        }

        async function processImage() {
            if (!originalBitmap) {
                alert('请先选择图片文件！');
                return;
            }
            
            // 由于已经有实时预览，这里只是更新状态
            status.textContent = '像素化转换完成！可以调节滑块查看不同效果';
        }

        // 像素化处理函数，基于content.js的实现
        async function applyPixelation(originalBitmap, pixelationX, pixelationY) {
            console.log(`应用 ${pixelationX}x${pixelationY} 像素化...`);
            
            const originalWidth = originalBitmap.width;
            const originalHeight = originalBitmap.height;
            const newWidth = Math.ceil(originalWidth / pixelationX);
            const newHeight = Math.ceil(originalHeight / pixelationY);

            // 创建源画布
            const sourceCanvas = new OffscreenCanvas(originalWidth, originalHeight);
            const sourceCtx = sourceCanvas.getContext('2d', { willReadFrequently: true });
            sourceCtx.imageSmoothingEnabled = false;
            sourceCtx.drawImage(originalBitmap, 0, 0);

            // 创建目标画布
            const targetCanvas = new OffscreenCanvas(newWidth, newHeight);
            const targetCtx = targetCanvas.getContext('2d', { willReadFrequently: true });
            targetCtx.imageSmoothingEnabled = false;

            const sourceImageData = sourceCtx.getImageData(0, 0, originalWidth, originalHeight);
            const targetImageData = targetCtx.createImageData(newWidth, newHeight);

            // 对每个像素化块进行处理
            for (let py = 0; py < newHeight; py++) {
                for (let px = 0; px < newWidth; px++) {
                    const startX = px * pixelationX;
                    const startY = py * pixelationY;
                    const endX = Math.min(startX + pixelationX, originalWidth);
                    const endY = Math.min(startY + pixelationY, originalHeight);

                    let totalR = 0, totalG = 0, totalB = 0, totalA = 0;
                    let pixelCount = 0;

                    // 计算块内所有像素的平均值
                    for (let y = startY; y < endY; y++) {
                        for (let x = startX; x < endX; x++) {
                            const sourceIndex = (y * originalWidth + x) * 4;
                            if (sourceImageData.data[sourceIndex + 3] > 0) { // 只处理非透明像素
                                totalR += sourceImageData.data[sourceIndex];
                                totalG += sourceImageData.data[sourceIndex + 1];
                                totalB += sourceImageData.data[sourceIndex + 2];
                                totalA += sourceImageData.data[sourceIndex + 3];
                                pixelCount++;
                            }
                        }
                    }

                    // 设置目标像素
                    if (pixelCount > 0) {
                        const avgR = Math.round(totalR / pixelCount);
                        const avgG = Math.round(totalG / pixelCount);
                        const avgB = Math.round(totalB / pixelCount);
                        const avgA = Math.round(totalA / pixelCount);

                        const targetIndex = (py * newWidth + px) * 4;
                        targetImageData.data[targetIndex] = avgR;
                        targetImageData.data[targetIndex + 1] = avgG;
                        targetImageData.data[targetIndex + 2] = avgB;
                        targetImageData.data[targetIndex + 3] = avgA;
                    }
                }
            }

            targetCtx.putImageData(targetImageData, 0, 0);
            return await createImageBitmap(targetCanvas);
        }
    </script>
</body>
</html>