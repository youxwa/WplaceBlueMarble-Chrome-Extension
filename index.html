<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图片像素化转换器</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        
        .upload-section {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            background: #fafafa;
        }
        
        .upload-section.dragover {
            border-color: #144eb9;
            background: #f0f4ff;
        }
        
        .file-input {
            display: none;
        }
        
        .upload-btn {
            background-color: #144eb9;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin-bottom: 10px;
        }
        
        .upload-btn:hover {
            background-color: #0f3d9e;
        }
        
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .control-group {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 6px;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
        }
        
        .control-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .preview-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-top: 30px;
        }
        
        .preview-box {
            border: 1px solid #ddd;
            border-radius: 8px;
            overflow: hidden;
            background: white;
        }
        
        .preview-header {
            background: #f8f9fa;
            padding: 15px;
            font-weight: bold;
            color: #555;
            border-bottom: 1px solid #ddd;
        }
        
        .preview-content {
            padding: 20px;
            text-align: center;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .preview-image {
            max-width: 100%;
            max-height: 400px;
            border: 1px solid #eee;
            image-rendering: pixelated;
        }
        
        .process-btn {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            margin-bottom: 20px;
        }
        
        .process-btn:hover {
            background-color: #218838;
        }
        
        .process-btn:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        
        .info {
            background: #e7f3ff;
            border: 1px solid #b3d7ff;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
            color: #0066cc;
        }
        
        .error {
            background: #ffe7e7;
            border: 1px solid #ffb3b3;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
            color: #cc0000;
        }
        
        .status {
            text-align: center;
            margin: 20px 0;
            font-style: italic;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>图片像素化转换器</h1>
        
        <div class="upload-section" id="uploadSection">
            <input type="file" id="fileInput" class="file-input" accept="image/png,image/jpeg,image/webp,image/bmp,image/gif">
            <button class="upload-btn" onclick="document.getElementById('fileInput').click()">选择图片文件</button>
            <p>或拖拽图片文件到此处</p>
            <p><small>支持 PNG, JPEG, WebP, BMP, GIF 格式</small></p>
        </div>
        
        <div class="controls">
            <div class="control-group">
                <label>X轴像素化倍数:</label>
                <input type="number" id="pixelationX" value="20" min="1" max="100">
            </div>
            <div class="control-group">
                <label>Y轴像素化倍数:</label>
                <input type="number" id="pixelationY" value="20" min="1" max="100">
            </div>
            <div class="control-group">
                <label>大小阈值 (像素):</label>
                <input type="number" id="sizeThreshold" value="100" min="10">
            </div>
            <div class="control-group">
                <label>像素数阈值:</label>
                <input type="number" id="pixelThreshold" value="10000" min="100">
            </div>
        </div>
        
        <button class="process-btn" id="processBtn" disabled onclick="processImage()">开始像素化转换</button>
        
        <div class="status" id="status"></div>
        
        <div class="preview-section">
            <div class="preview-box">
                <div class="preview-header">原图预览</div>
                <div class="preview-content" id="originalPreview">
                    <span style="color: #999;">请先选择图片文件</span>
                </div>
            </div>
            
            <div class="preview-box">
                <div class="preview-header">像素化效果预览</div>
                <div class="preview-content" id="pixelatedPreview">
                    <span style="color: #999;">等待处理...</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentFile = null;
        let originalBitmap = null;

        // 拖拽功能
        const uploadSection = document.getElementById('uploadSection');
        const fileInput = document.getElementById('fileInput');
        const processBtn = document.getElementById('processBtn');
        const status = document.getElementById('status');

        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });

        uploadSection.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
        });

        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        async function handleFile(file) {
            const validTypes = ['image/png', 'image/jpeg', 'image/webp', 'image/bmp', 'image/gif'];
            if (!validTypes.includes(file.type)) {
                alert('请选择有效的图片文件格式！');
                return;
            }

            currentFile = file;
            processBtn.disabled = false;
            
            // 显示原图预览
            const reader = new FileReader();
            reader.onload = (e) => {
                const originalPreview = document.getElementById('originalPreview');
                originalPreview.innerHTML = `
                    <img src="${e.target.result}" class="preview-image" alt="原图预览">
                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                        文件名: ${file.name}<br>
                        大小: ${(file.size / 1024).toFixed(2)} KB
                    </div>
                `;
            };
            reader.readAsDataURL(file);
            
            status.textContent = `已选择文件: ${file.name}`;
        }

        async function processImage() {
            if (!currentFile) {
                alert('请先选择图片文件！');
                return;
            }

            processBtn.disabled = true;
            status.textContent = '正在处理图片...';

            try {
                // 创建ImageBitmap
                originalBitmap = await createImageBitmap(currentFile);
                
                const pixelationX = parseInt(document.getElementById('pixelationX').value);
                const pixelationY = parseInt(document.getElementById('pixelationY').value);
                const sizeThreshold = parseInt(document.getElementById('sizeThreshold').value);
                const pixelThreshold = parseInt(document.getElementById('pixelThreshold').value);
                
                status.textContent = `正在应用 ${pixelationX}x${pixelationY} 像素化...`;
                
                // 应用像素化
                const pixelatedBitmap = await applyPixelation(originalBitmap, pixelationX, pixelationY);
                
                // 显示像素化预览
                const canvas = document.createElement('canvas');
                canvas.width = pixelatedBitmap.width;
                canvas.height = pixelatedBitmap.height;
                const ctx = canvas.getContext('2d');
                ctx.imageSmoothingEnabled = false;
                ctx.drawImage(pixelatedBitmap, 0, 0);
                
                const pixelatedPreview = document.getElementById('pixelatedPreview');
                
                // 计算显示尺寸，确保像素化效果明显
                const maxDisplaySize = 400;
                const scale = Math.min(maxDisplaySize / pixelatedBitmap.width, maxDisplaySize / pixelatedBitmap.height);
                const displayWidth = Math.floor(pixelatedBitmap.width * scale);
                const displayHeight = Math.floor(pixelatedBitmap.height * scale);
                
                pixelatedPreview.innerHTML = `
                    <canvas width="${displayWidth}" height="${displayHeight}" 
                            class="preview-image" style="border: 1px solid #eee; image-rendering: pixelated; image-rendering: -moz-crisp-edges; image-rendering: crisp-edges;"></canvas>
                    <div style="margin-top: 10px; font-size: 12px; color: #666;">
                        原始尺寸: ${originalBitmap.width} × ${originalBitmap.height}<br>
                        像素化尺寸: ${pixelatedBitmap.width} × ${pixelatedBitmap.height}<br>
                        像素化倍数: ${pixelationX} × ${pixelationY}<br>
                        压缩比: ${((originalBitmap.width * originalBitmap.height) / (pixelatedBitmap.width * pixelatedBitmap.height)).toFixed(1)}x
                    </div>
                `;
                
                const previewCanvas = pixelatedPreview.querySelector('canvas');
                const previewCtx = previewCanvas.getContext('2d');
                previewCtx.imageSmoothingEnabled = false;
                previewCtx.drawImage(pixelatedBitmap, 0, 0, displayWidth, displayHeight);
                
                status.textContent = '像素化转换完成！';
                
            } catch (error) {
                console.error('处理图片时出错:', error);
                status.textContent = '处理图片时出错: ' + error.message;
            } finally {
                processBtn.disabled = false;
            }
        }

        // 像素化处理函数，基于content.js的实现
        async function applyPixelation(originalBitmap, pixelationX, pixelationY) {
            console.log(`应用 ${pixelationX}x${pixelationY} 像素化...`);
            
            const originalWidth = originalBitmap.width;
            const originalHeight = originalBitmap.height;
            const newWidth = Math.ceil(originalWidth / pixelationX);
            const newHeight = Math.ceil(originalHeight / pixelationY);

            // 创建源画布
            const sourceCanvas = new OffscreenCanvas(originalWidth, originalHeight);
            const sourceCtx = sourceCanvas.getContext('2d', { willReadFrequently: true });
            sourceCtx.imageSmoothingEnabled = false;
            sourceCtx.drawImage(originalBitmap, 0, 0);

            // 创建目标画布
            const targetCanvas = new OffscreenCanvas(newWidth, newHeight);
            const targetCtx = targetCanvas.getContext('2d', { willReadFrequently: true });
            targetCtx.imageSmoothingEnabled = false;

            const sourceImageData = sourceCtx.getImageData(0, 0, originalWidth, originalHeight);
            const targetImageData = targetCtx.createImageData(newWidth, newHeight);

            // 对每个像素化块进行处理
            for (let py = 0; py < newHeight; py++) {
                for (let px = 0; px < newWidth; px++) {
                    const startX = px * pixelationX;
                    const startY = py * pixelationY;
                    const endX = Math.min(startX + pixelationX, originalWidth);
                    const endY = Math.min(startY + pixelationY, originalHeight);

                    let totalR = 0, totalG = 0, totalB = 0, totalA = 0;
                    let pixelCount = 0;

                    // 计算块内所有像素的平均值
                    for (let y = startY; y < endY; y++) {
                        for (let x = startX; x < endX; x++) {
                            const sourceIndex = (y * originalWidth + x) * 4;
                            if (sourceImageData.data[sourceIndex + 3] > 0) { // 只处理非透明像素
                                totalR += sourceImageData.data[sourceIndex];
                                totalG += sourceImageData.data[sourceIndex + 1];
                                totalB += sourceImageData.data[sourceIndex + 2];
                                totalA += sourceImageData.data[sourceIndex + 3];
                                pixelCount++;
                            }
                        }
                    }

                    // 设置目标像素
                    if (pixelCount > 0) {
                        const avgR = Math.round(totalR / pixelCount);
                        const avgG = Math.round(totalG / pixelCount);
                        const avgB = Math.round(totalB / pixelCount);
                        const avgA = Math.round(totalA / pixelCount);

                        const targetIndex = (py * newWidth + px) * 4;
                        targetImageData.data[targetIndex] = avgR;
                        targetImageData.data[targetIndex + 1] = avgG;
                        targetImageData.data[targetIndex + 2] = avgB;
                        targetImageData.data[targetIndex + 3] = avgA;
                    }
                }
            }

            targetCtx.putImageData(targetImageData, 0, 0);
            return await createImageBitmap(targetCanvas);
        }
    </script>
</body>
</html>